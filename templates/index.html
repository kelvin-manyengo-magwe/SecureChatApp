<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Web Chat - {{ session.display_name }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* Basic styling - keep or improve */
        body { font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f4f4f4; }
        #top-bar { display: flex; justify-content: space-between; align-items: center; background-color: #333; color: white; padding: 10px 20px; }
        #top-bar h1 { margin: 0; font-size: 1.5em; }
        #top-bar a { color: #ddd; text-decoration: none; padding: 5px 10px; border-radius: 3px; }
        #top-bar a:hover { background-color: #555; }
        #main-content { display: flex; flex-grow: 1; overflow: hidden; }
        #sidebar { width: 200px; background-color: #e9e9e9; padding: 15px; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
        #sidebar h3 { margin-top: 0; margin-bottom: 10px; }
        #sidebar ul { list-style-type: none; padding: 0; margin: 0 0 20px 0; }
        #sidebar ul li button { display: block; width: 100%; padding: 8px; margin-bottom: 5px; background-color: #f9f9f9; border: 1px solid #ddd; text-align: left; cursor: pointer; border-radius: 3px; }
        #sidebar ul li button:hover, #sidebar ul li button.active { background-color: #dcf8c6; }
        #sidebar .create-room-section { margin-top: auto; } /* Pushes to bottom */
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; max-width: 800px; width: 100%; margin: 0 auto; background-color: white; } /* Removed border & shadow */
        #messages { list-style-type: none; margin: 0; padding: 20px; overflow-y: auto; flex-grow: 1; border-bottom: 1px solid #eee; }
        /* Message styles (my-message, other-message, system-message) same as before */
        #messages li { padding: 8px 12px; margin-bottom: 10px; border-radius: 5px; word-wrap: break-word; max-width: 80%; }
        #messages li.my-message { background-color: #dcf8c6; margin-left: auto; text-align: right; }
        #messages li.other-message { background-color: #f1f0f0; margin-right: auto; text-align: left; }
        #messages li.system-message { font-style: italic; color: #777; text-align: center; background-color: transparent; font-size: 0.9em; }
        #messages li strong { display: block; margin-bottom: 4px; font-size: 0.9em; color: #555; }
        #form { display: flex; padding: 10px; border-top: 1px solid #eee;}
        #input { border: 1px solid #ccc; padding: 10px; flex-grow: 1; border-radius: 5px 0 0 5px; }
        #send-button { background-color: #5cb85c; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 0 5px 5px 0; }
        #send-button:hover { background-color: #4cae4c; }
    </style>
</head>
<body>
    <div id="top-bar">
        <h1>Secure Web Chat</h1>
        <div>
            <span>Welcome, {{ session.display_name }} ({{ session.role }})</span>
            <a href="{{ url_for('logout') }}" style="margin-left: 15px;">Logout</a>
        </div>
    </div>

    <div id="main-content">
        <div id="sidebar">
            <h3>Chat Rooms</h3>
            <ul id="room-list">
                {% for room in rooms %}
                    <li><button data-room="{{ room }}">{{ room }}</button></li>
                {% endfor %}
            </ul>
            {% if user_role == 'teacher' or user_role == 'administrator' %}
            <div class="create-room-section">
                <h4>Create New Room</h4>
                <input type="text" id="new-room-name" placeholder="Enter room name" style="width: calc(100% - 10px); padding: 5px; margin-bottom: 5px;">
                <button id="create-room-btn" style="width: 100%; padding: 8px; background-color: #007bff; color:white; border:none; border-radius: 3px;">Create Room</button>
            </div>
            {% endif %}
        </div>

        <div id="chat-container">
            <ul id="messages"></ul>
            <form id="form" action="">
                <input id="input" autocomplete="off" placeholder="Type a message..." /><button id="send-button">Send</button>
            </form>
        </div>
    </div>

    <script>
        const socket = io(); // Connects to the same host that serves the page
        let currentRoom = "{{ rooms[0] }}"; // Default to the first room
        const userDisplayName = "{{ session.display_name }}"; // Get user's name from Flask session

        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const roomList = document.getElementById('room-list');
        const createRoomBtn = document.getElementById('create-room-btn');
        const newRoomNameInput = document.getElementById('new-room-name');


        function addMessageToList(data, type = 'other') {
            const item = document.createElement('li');
            let content = '';
            if (type === 'system') {
                item.classList.add('system-message');
                content = data.msg;
            } else {
                content = `<strong>${data.username}</strong>${data.msg}`;
                if (data.username === userDisplayName) { // Compare with current user's display name
                    item.classList.add('my-message');
                } else {
                    item.classList.add('other-message');
                }
            }
            item.innerHTML = content; // Use innerHTML if content includes HTML (like <strong>)
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateActiveRoomButton(roomName) {
            document.querySelectorAll('#room-list button').forEach(btn => {
                if (btn.dataset.room === roomName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            document.querySelector('#top-bar h1').textContent = `Secure Web Chat - ${roomName}`;

        }

        // Initial join for default room
        socket.on('connect', () => {
            console.log('Socket.IO connected!');
            // We handle initial room joining on server side connect for simplicity now
            // If server doesn't auto-join, client should emit('join_room') here.
            // Update UI for default room
            if (roomList.querySelector('button')) { // if rooms exist
                const defaultRoomName = roomList.querySelector('button').dataset.room;
                updateActiveRoomButton(defaultRoomName);
            }
        });


        roomList.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                const roomName = e.target.dataset.room;
                if (roomName !== currentRoom) {
                    socket.emit('join_room', { room: roomName });
                }
            }
        });

        socket.on('joined_room_ack', function(data) {
            currentRoom = data.room;
            messages.innerHTML = ''; // Clear messages from old room
            addMessageToList({ msg: `You joined '${currentRoom}'.` }, 'system');
            updateActiveRoomButton(currentRoom);
            input.focus();
        });


        if (createRoomBtn) { // Element exists if user role allows
            createRoomBtn.addEventListener('click', function() {
                const roomName = newRoomNameInput.value.trim();
                if (roomName) {
                    socket.emit('create_room_request', { room_name: roomName });
                    newRoomNameInput.value = '';
                } else {
                    alert('Please enter a room name.');
                }
            });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat_message', { msg: input.value }); // Server uses session for room
                input.value = '';
            }
        });

        socket.on('new_message', function(data) {
            addMessageToList(data);
        });

        socket.on('system_message', function(data) {
            addMessageToList(data, 'system');
        });

        socket.on('error_msg', function(data) {
            addMessageToList({ msg: `Error: ${data.msg}` }, 'system'); // Display errors as system messages
             // Or use an alert: alert(`Error: ${data.msg}`);
        });

        socket.on('new_room_available', function(data) {
            const item = document.createElement('li');
            const button = document.createElement('button');
            button.dataset.room = data.room_name;
            button.textContent = data.room_name;
            item.appendChild(button);
            roomList.appendChild(item);
            addMessageToList({ msg: `New room '${data.room_name}' available (created by ${data.creator}).` }, 'system');
        });

        socket.on('connect_error', (err) => {
            console.error("Socket.IO Connection Error:", err);
            addMessageToList({msg: `Socket.IO Connection Error: ${err.message}. Please try refreshing.`}, 'system');
        });
        socket.on('disconnect', (reason) => {
            console.log("Socket.IO Disconnected:", reason);
            addMessageToList({msg: `Disconnected from chat server: ${reason}.`}, 'system');
        });

    </script>
</body>
</html>
